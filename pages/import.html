<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gleneagles MC</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
    }

    header.sticky-header {
      position: sticky;
      top: 0;
      background: #f8f8f8;
      padding: 0.5em 1em;
      border-bottom: 1px solid #ccc;
      z-index: 1000;
      text-align: center;
    }

    .logo-container img {
      height: 64px;
      width: auto;
      margin-bottom: 0.3em;
    }

    .datetime {
      font-size: 0.9em;
      color: #333;
      margin-bottom: 0.3em;
    }

    .return-home {
      padding: 0.3em 0.6em;
      font-size: 0.9em;
      background: #0077cc;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
    }

    #cancelButton {
      display: none;
    }
    #commitButton {
      display: none;
    }
  </style>
</head>
<body>
  <header class="sticky-header">
    <div class="logo-container">
      <img src="GE_logo.png" alt="Gleneagles Logo" />
    </div>
    <div class="datetime" id="datetime">Loading time…</div>
    <a href="index.html" class="return-home">Return to Home</a>
  </header>

  <!-- ✅ Required DOM elements -->
  <label for="cutoffInput"><strong>Low/High Cutoff:</strong></label>
  <button id="commitButton">Commit to Players Table</button>
  <br />
  <input type="file" id="fileInput" accept=".csv" title="Select a CSV file to import" placeholder="Choose CSV file" />
  <button id="commitButton">Commit to Players Table</button>
  <button id="cancelButton">Cancel Import</button>
  <div id="status" class="status"></div>
  <div id="preview"></div>


<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabase = createClient(
    'https://ekevotcpnrzncxigemnp.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVrZXZvdGNwbnJ6bmN4aWdlbW5wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NDkwMTAsImV4cCI6MjA3NjAyNTAxMH0.D6iIHHlfGfpuh0NkUTVMWOWE7Vepw9GlJn_OcfRxg6E'
  );

  const fileInput = document.getElementById('fileInput');
  const cutoffInput = document.getElementById('cutoffInput');
  const status = document.getElementById('status');
  const preview = document.getElementById('preview');
  const commitButton = document.getElementById('commitButton');
  const cancelButton = document.getElementById('cancelButton');

  let importedRawRows = [];

  function classifyRows(rawRows, cutoff) {
    return rawRows.map(row => {
      const thc = Math.ceil(row.handicap / 2);
      const hhc = row.handicap / 2;
      const high_low = row.handicap <= cutoff ? 'Low' : 'High';
      return {
        ...row,
        thc,
        hhc,
        high_low
      };
    });
  }

  function renderTable(rows, title) {
    if (!rows.length) return `<h3>${title}</h3><p>None</p>`;

    const lowCount = rows.filter(r => r.high_low === 'Low').length;
    const highCount = rows.filter(r => r.high_low === 'High').length;

    return `
      <div style="text-align:center; margin-bottom:0.5rem;">
        <p><strong>Low:</strong> ${lowCount} players <strong>High:</strong> ${highCount} players</p>
        <h3>${title} (${rows.length})</h3>
      </div>
      <table style="font-size:0.85rem; width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="text-align:right;">#</th>
            <th style="text-align:left;">Name</th>
            <th style="text-align:left;">First</th>
            <th style="text-align:left;">Last</th>
            <th style="text-align:right;">Handicap</th>
            <th style="text-align:left;">City</th>
            <th style="text-align:left;">Tour City</th>
            <th style="text-align:left;">Address</th>
            <th style="text-align:left;">Postal Code</th>
            <th style="text-align:left;">Email</th>
            <th style="text-align:left;">Phone</th>
            <th style="text-align:right;">THC</th>
            <th style="text-align:right;">HHC</th>
            <th style="text-align:left;">High/Low</th>
            <th style="text-align:left;">Network ID</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map((row, index) => {
            const bg = row.high_low === 'Low'
              ? 'background-color:#fff9c4;'
              : row.high_low === 'High'
              ? 'background-color:#ffe0b2;'
              : '';
            return `
              <tr style="${bg}">
                <td style="text-align:right;">${index + 1}</td>
                <td style="text-align:left;">${row.name}</td>
                <td style="text-align:left;">${row.first}</td>
                <td style="text-align:left;">${row.last}</td>
                <td style="text-align:right;">${row.handicap}</td>
                <td style="text-align:left;">${row.city || ''}</td>
                <td style="text-align:left;">${row.tour_city || ''}</td>
                <td style="text-align:left;">${row.address || ''}</td>
                <td style="text-align:left;">${row.postal_code || ''}</td>
                <td style="text-align:left;">${row.email || ''}</td>
                <td style="text-align:left;">${row.phone || ''}</td>
                <td style="text-align:right;">${row.thc}</td>
                <td style="text-align:right;">${row.hhc}</td>
                <td style="text-align:left;">${row.high_low}</td>
                <td style="text-align:left;">${row.network_id}</td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    `;
  }

  cancelButton.addEventListener('click', () => {
    status.textContent = '';
    status.className = 'status';
    preview.innerHTML = '';
    commitButton.style.display = 'none';
    cancelButton.style.display = 'none';
    importedRawRows = [];
  });

  cutoffInput.addEventListener('input', () => {
    const cutoff = parseFloat(cutoffInput.value);
    if (isNaN(cutoff) || importedRawRows.length === 0) return;
    const reclassified = classifyRows(importedRawRows, cutoff);
    preview.innerHTML = renderTable(reclassified, 'Updated Preview');
  });

  fileInput.addEventListener('click', () => {
    fileInput.value = null;
  });

  fileInput.addEventListener('change', async () => {
    try {
      const file = fileInput.files[0];
      if (!file) return;

      status.textContent = '⏳ Clearing previous import...';
      status.className = 'status loading';
      preview.innerHTML = '';
      await supabase.from('players_import').delete().not('network_id', 'is', null);

      status.textContent = '⏳ Importing new file...';

      const text = await file.text();
      const lines = text.trim().split(/\r?\n/);
      const headers = lines[0].replace(/^\uFEFF/, '').split(',').map(h => h.trim().toLowerCase());
      importedRawRows = [];

      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim());
        const row = {};
        headers.forEach((h, idx) => row[h] = values[idx]);

        const name = row.name || `${row.first || ''} ${row.last || ''}`.trim();
        const first = row.first || '';
        const last = row.last || '';
        const network_id = row.network_id || '';
        const handicap = parseFloat(row.handicap);
        if (!name || !network_id || isNaN(handicap)) continue;

        importedRawRows.push({
          network_id,
          name,
          first,
          last,
          handicap,
          city: row.city || '',
          tour_city: row.tour_city || '',
          address: row.address || '',
          postal_code: row.postal_code || '',
          email: row.email || '',
          phone: row.phone || ''
        });
      }

      if (importedRawRows.length === 0) {
        status.textContent = '⚠️ No valid rows found in the file.';
        status.className = 'status error';
        return;
      }

      const cutoff = parseFloat(cutoffInput.value);
      const classified = classifyRows(importedRawRows, cutoff);
      await supabase.from('players_import').insert(classified);

      status.textContent = `✅ Import complete: ${classified.length} rows added`;
      status.className = 'status success';
      commitButton.style.display = 'inline-block';
      cancelButton.style.display = 'inline-block';

      preview.innerHTML = renderTable(classified, 'Imported Rows');
      preview.scrollIntoView({ behavior: 'smooth' });
    } catch (err) {
      console.error('Import failed:', err);
      status.textContent = `❌ Import failed: ${err.message || err}`;
      status.className = 'status error';
    }
  });

  commitButton.addEventListener('click', async () => {
    try {
      if (!Array.isArray(importedRawRows) || importedRawRows.length === 0) {
        status.textContent = '⚠️ No data to commit.';
        status.className = 'status error';
        return;
      }

      status.textContent = '⏳ Committing to players table...';
      status.className = 'status loading';

      const cutoff = parseFloat(cutoffInput.value);
      const classified = classifyRows(importedRawRows, cutoff);

           await supabase.from('players').insert(classified);

      status.textContent = `✅ Players table updated with ${classified.length} rows`;
      status.className = 'status success';
      preview.scrollIntoView({ behavior: 'smooth' });
    } catch (err) {
      console.error('Commit failed:', err);
      status.textContent = `❌ Commit failed: ${err.message || err}`;
      status.className = 'status error';
    }
  });
</script>



</body>
</html>
     
</body>
</html>