<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Honeypot Payout Editor</title>

  <!-- Shared Styles -->
  <link rel="stylesheet" href="styles/header.css" />

  <!-- Page-Specific Styles -->
  <link rel="stylesheet" href="styles/payout_editor.css" />
</head>
<body>

  <!-- Modular Sticky Header -->
  <div id="headerContainer"></div>

  <!-- Page Content -->
  <!-- Your table, forms, and other UI go here -->

  <!-- Shared Scripts -->
  <script src="scripts/sticky_header.js"></script>
  <script>
    loadStickyHeader("Honeypot Payout Editor");
  </script>

  <!-- Page Content -->
  
  <div id="statusBar" class="status-bar">
  <div id="status" class="status">‚úÖ Loaded 25 entries</div>
  <button id="saveButton">üíæ Save Changes</button>
  </div>

  <div id="tableContainer"></div>

  <!-- Supabase Integration -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient(
      'https://ekevotcpnrzncxigemnp.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVrZXZvdGNwbnJ6bmN4aWdlbW5wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NDkwMTAsImV4cCI6MjA3NjAyNTAxMH0.D6iIHHlfGfpuh0NkUTVMWOWE7Vepw9GlJn_OcfRxg6E'
    );

    const status = document.getElementById('status');
    const tableContainer = document.getElementById('tableContainer');
    const saveButton = document.getElementById('saveButton');
    let originalData = [];

    async function loadData() {
      status.textContent = '‚è≥ Loading data...';
      status.className = 'status';

      const { data, error } = await supabase.from('honeypot_payout').select('*');
      if (error) {
        status.textContent = `‚ùå Error loading data: ${error.message}`;
        status.className = 'status error';
        return;
      }

      originalData = data;
      renderTable(data);
      status.textContent = `‚úÖ Loaded ${data.length} entries`;
      status.className = 'status success';
    }

function renderTable(data) {
  if (!data.length) {
    tableContainer.innerHTML = '<p>No entries found.</p>';
    return;
  }

  const columns = Object.keys(data[0]);
  const table = document.createElement('table');
  table.className = 'payout-table';

  const thead = document.createElement('thead');
  const tbody = document.createElement('tbody');

  // Header row
  const headerRow = document.createElement('tr');
  headerRow.innerHTML = `<th class="align-center narrow">#</th>` +
    columns.map(col => {
      const title = col.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
      const widthClass = col.length <= 6 ? 'narrow' : col.length <= 12 ? 'medium' : 'wide';
      return `<th class="${widthClass}">${title}</th>`;
    }).join('');
  thead.appendChild(headerRow);

  data.forEach((row, rowIndex) => {
    const tr = document.createElement('tr');
    tr.className = rowIndex % 2 === 0 ? 'even-row' : 'odd-row';

    tr.innerHTML = `<td class="align-center row-index">${rowIndex + 1}</td>` +
      columns.map(col => {
        const value = row[col];
        const isNumeric = typeof value === 'number' || /^\d+(\.\d+)?$/.test(value);
        const alignClass = isNumeric ? 'align-right' : 'align-left';
        return `
          <td class="${alignClass}">
            <input class="cell-input" value="${value}" data-row="${rowIndex}" data-column="${col}" />
          </td>`;
      }).join('');
    tbody.appendChild(tr);
  });

  table.appendChild(thead);
  table.appendChild(tbody);
  tableContainer.innerHTML = '';
  tableContainer.appendChild(table);
}
    saveButton.addEventListener('click', async () => {
  const inputs = document.querySelectorAll('td input');
  const updatedRows = [...originalData];

  inputs.forEach(input => {
    const row = parseInt(input.dataset.row);
    const column = input.dataset.column;
    updatedRows[row][column] = input.value;
  });

  status.textContent = '‚è≥ Saving changes...';
  status.className = 'status';

  const updates = await Promise.all(
    updatedRows.map(row => {
      if (!row.id) {
        console.warn('Missing ID for row:', row);
        return { error: { message: 'Missing ID' } };
      }
      return supabase
        .from('honeypot_payout')
        .update(row)
        .eq('id', row.id);
    })
  );

  const hasError = updates.some(r => r.error);
  if (hasError) {
    status.textContent = '‚ùå Error saving some rows.';
    status.className = 'status error';
  } else {
    status.textContent = '‚úÖ All changes saved.';
    status.className = 'status success';
  }
});

    loadData();
  </script>

</body>
</html>