<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gleneagles Men's Club</title>
  <style>
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      max-width: 1000px;
      margin: 2rem auto;
      padding: 0 1rem;
      background: #f9f9f9;
    }
    .controls, .pagination {
      text-align: center;
      margin: 1rem 0;
    }
    .controls button, .pagination button {
      margin: 0 0.5rem;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    th, td {
      text-align: left;
      padding: 0.75rem;
      border-bottom: 1px solid #ddd;
    }
    th {
      background: #f0f0f0;
    }
    .muted {
      color: #666;
      font-size: 0.9rem;
      text-align: center;
      padding: 1rem;
    }
    .row-low {
      background-color: #fffde7;
    }
    .row-high {
      background-color: #fff3e0;
    }
    #stickyHeader {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    #datetime {
      font-size: 1.2rem;
      font-weight: bold;
      background: #f0f0f0;
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      color: #333;
    }
    .count-summary {
      text-align: center;
      font-weight: bold;
      margin-top: 0.5rem;
      color: #444;
    }
    .logo-container {
      text-align: center;
      padding: 0.5rem;
    }
    .header-logo-container {
      text-align: center;
      padding: 0.5rem;
    }
    .logo-img {
      max-height: 180px;
    }
    .centered-padding {
      text-align: center;
      padding: 0.5rem;
    }

    /* Moved inline header row styles here */
    .header-row {
      display: flex;
      justify-content: center;
      font-weight: bold;
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      text-decoration: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      display: inline-block;
    }

    /* Header controls moved from inline styles */
    .header-controls {
      display: flex;
      justify-content: center;
      gap: 2rem;
      align-items: center;
      padding: 0.5rem 1rem;
    }

    /* Button style moved from inline attributes */
      .btn-primary {
        background: #0077cc;
        color: #fff;
        font-weight: bold;
        padding: 0.6rem 1.2rem;
        border-radius: 6px;
        text-decoration: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }
  
      /* Reusable flex container instead of inline styles */
      .flex-center {
        display: flex;
        justify-content: center;
        gap: 1rem;
        align-items: center;
      }
  
    </style>
  </head>
  <body>
  
    <header class="header-row" role="banner">
      <div class="header-controls">
        <div id="datetime">Loading time...</div>
        <a href="index.html" class="btn-primary">Return to Home</a>
      </div>
      <div class="centered-padding">
        <img src="GE_Logo.png" alt="Gleneagles Logo" class="logo-img" />
      </div>
    </header>

  <script>
    function updateDateTime() {
      const now = new Date();
      const options = {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        second: '2-digit'
      };
      document.getElementById('datetime').textContent = now.toLocaleString('en-US', options);
    }
    updateDateTime();
    setInterval(updateDateTime, 1000);
  </script>

  <div class="controls">
    <button id="sortLast">Sort by Last Name</button>
    <button id="sortFirst">Sort by First Name</button>
    <button id="sortHandicap">Sort by Handicap</button>
    <button id="sortHighLow">Sort by High/Low</button>
  </div>

  <div class="count-summary" id="countSummary">Loading player counts...</div>

  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Name</th>
        <th>Handicap</th>
        <th>Honeypot</th>
        <th>Tournament</th>
        <th>High/Low</th>
      </tr>
    </thead>
    <tbody id="players-body">
      <tr><td colspan="6" class="muted">Loading players...</td></tr>
    </tbody>
  </table>

  <div class="pagination">
    <button id="prevPage">Previous</button>
    <span id="page-info"></span>
    <button id="nextPage">Next</button>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient(
      'https://ekevotcpnrzncxigemnp.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVrZXZvdGNwbnJ6bmN4aWdlbW5wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NDkwMTAsImV4cCI6MjA3NjAyNTAxMH0.D6iIHHlfGfpuh0NkUTVMWOWE7Vepw9GlJn_OcfRxg6E'
    );

    const playersBody = document.getElementById('players-body');
    const pageInfo = document.getElementById('page-info');
    const countSummary = document.getElementById('countSummary');
    const sortButtons = {
      last: document.getElementById('sortLast'),
      first: document.getElementById('sortFirst'),
      handicap: document.getElementById('sortHandicap'),
      high_low: document.getElementById('sortHighLow')
    };
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');

    let allPlayers = [];
    let sortField = 'last';
    let sortDirection = 'asc';
    let currentPage = 0;
    const pageSize = 20;

    function escapeHtml(s) {
      return s == null ? '' : String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function updateSortLabels() {
      for (const field in sortButtons) {
        const btn = sortButtons[field];
        const arrow = (field === sortField) ? (sortDirection === 'asc' ? ' ↑' : ' ↓') : '';
        const label = {
          last: 'Sort by Last Name',
          first: 'Sort by First Name',
          handicap: 'Sort by Handicap',
          high_low: 'Sort by High/Low'
        }[field];
        btn.textContent = label + arrow;
      }
    }

    function sortPlayers(data) {
      return [...data].sort((a, b) => {
        const aVal = a[sortField];
        const bVal = b[sortField];
        let result;
        if (sortField === 'handicap') {
          result = (Number(aVal) || 0) - (Number(bVal) || 0);
        } else {
          const aStr = String(aVal ?? '').toLowerCase();
          const bStr = String(bVal ?? '').toLowerCase();
          result = aStr.localeCompare(bStr);
        }
        return sortDirection === 'asc' ? result : -result;
      });
    }

    function getRowClass(highLow) {
      const val = String(highLow ?? '').toLowerCase();
      if (val === 'low') return 'row-low';
      if (val === 'high') return 'row-high';
      return '';
    }

    function updateCountSummary() {
  const total = allPlayers.length;
  const highCount = allPlayers.filter(p => String(p.high_low).toLowerCase() === 'high').length;
  const lowCount = allPlayers.filter(p => String(p.high_low).toLowerCase() === 'low').length;
  countSummary.textContent = `Total: ${total} players | High: ${highCount} | Low: ${lowCount}`;
}

    function renderTable() {
      const sorted = sortPlayers(allPlayers);
      const start = currentPage * pageSize;
           const end = start + pageSize;
      const pagePlayers = sorted.slice(start, end);

      if (pagePlayers.length === 0) {
        playersBody.innerHTML = '<tr><td colspan="6" class="muted">No players found</td></tr>';
        pageInfo.textContent = '';
        return;
      }

      playersBody.innerHTML = pagePlayers.map((p, i) => `
        <tr class="${getRowClass(p.high_low)}">
          <td>${start + i + 1}</td>
          <td>${escapeHtml(p.name)}</td>
          <td>${escapeHtml(p.handicap)}</td>
          <td>${escapeHtml(p.hhc)}</td>
          <td>${escapeHtml(p.thc)}</td>
          <td>${escapeHtml(p.high_low)}</td>
        </tr>
      `).join('');

      const totalPages = Math.ceil(allPlayers.length / pageSize);
      pageInfo.textContent = `Page ${currentPage + 1} of ${totalPages}`;
    }

    function setSort(field) {
      if (sortField === field) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        sortField = field;
        sortDirection = 'asc';
      }
      currentPage = 0;
      updateSortLabels();
      renderTable();
    }

    for (const field in sortButtons) {
      sortButtons[field].addEventListener('click', () => setSort(field));
    }

    prevPageBtn.addEventListener('click', () => {
      if (currentPage > 0) {
        currentPage--;
        renderTable();
      }
    });

    nextPageBtn.addEventListener('click', () => {
      const maxPage = Math.floor(allPlayers.length / pageSize);
      if (currentPage < maxPage) {
        currentPage++;
        renderTable();
      }
    });

    async function fetchPlayers() {
      const { data, error } = await supabase
        .from('players')
        .select('first, last, name, handicap, hhc, thc, high_low');

      if (error) {
        playersBody.innerHTML = `<tr><td colspan="6" class="muted">Error loading players: ${escapeHtml(error.message)}</td></tr>`;
        pageInfo.textContent = '';
        countSummary.textContent = '';
        return;
      }

      allPlayers = data || [];
      currentPage = 0;
      updateSortLabels();
      updateCountSummary();
      renderTable();
    }

    fetchPlayers();
    setInterval(fetchPlayers, 30000);
  </script>
</body>
</html>